# Maintainer: Zelun Kong <zelun.kong@outlook.com>

pkgname=glib2
pkgver=2.74.0
pkgrel=1
epoch=
pkgdesc="Low level core library"
arch=('x86_64')
url="https://wiki.gnome.org/Projects/GLib"
license=('KZL')
depends=(libffi pcre)
makedepends=(dbus elfutils shared-mime-info)
optdepends=("elfutils: gresource inspection tool")
source=(git+https://gitlab.gnome.org/GNOME/glib.git#tag=$pkgver?signed
        gio-querymodules.{script,hook}
        glib-compile-schemas.hook)
sha256sums=('SKIP'
            '2d3c1919c09d529cf946bdbc926d53629b78ac87a52a7387b7a9f5d8b999ecae'
            '6bb6eef2768fe9f1aafabb97c44201d3e0a2a2cf74b479df0f812da2c566b1ce'
            '018c62a1087461cb1f5dd2a879667d7218e4990c1b4c322e584dc3ef311342ca')
validpgpkeys=('D4C501DA48EB797A081750939449C2F50996635F')

build() {
  cd $pkgname

  meson setup \
    --prefix /usr \
    --libexecdir lib \
    --sbindir bin \
    --auto-features enabled \
    --buildtype plain \
    --wrap-mode nodownload \
    --default-library both \
    -D b_lto=true \
    -D b_pie=true \
    -D gtk_doc=false \
    -D man=false \
    -D selinux=disabled \
    build

  meson compile -C build
}

check() {
  cd $pkgname

  meson test -C build --no-suite flaky --print-errorlogs
}

package() {
  cd $pkgname

  meson install -C build --destdir="$pkgdir/"

  install -Dm644 "$srcdir"/*.hook -t "$pkgdir"/usr/share/libalpm/hooks
  install -D "$srcdir"/gio-querymodules.script "$pkgdir"/usr/share/libalpm/scripts/gio-querymodules

  export PYTHONHASHSEED=0
  python -m compileall -d /usr/share/glib-2.0/codegen "$pkgdir/usr/share/glib-2.0/codegen"
  python -O -m compileall -d /usr/share/glib-2.0/codegen "$pkgdir/usr/share/glib-2.0/codegen"
}
