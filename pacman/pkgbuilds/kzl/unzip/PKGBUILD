# Maintainer: Zelun Kong <zelun.kong@outlook.com>

pkgname=unzip
pkgver=60
pkgrel=1
epoch=1
pkgdesc="For extracting and viewing files in .zip archives"
arch=('x86_64')
url="http://infozip.sourceforge.net/UnZip.html"
license=('KZL')
source=(
  https://downloads.sourceforge.net/infozip/${pkgname}${pkgver}.tar.gz
  https://src.fedoraproject.org/rpms/unzip/raw/rawhide/f/unzip-6.0-exec-shield.patch
  https://src.fedoraproject.org/rpms/unzip/raw/rawhide/f/unzip-6.0-close.patch
  https://src.fedoraproject.org/rpms/unzip/raw/rawhide/f/unzip-6.0-attribs-overflow.patch
  https://src.fedoraproject.org/rpms/unzip/raw/rawhide/f/unzip-6.0-symlink.patch
  https://src.fedoraproject.org/rpms/unzip/raw/rawhide/f/unzip-6.0-format-secure.patch
  https://src.fedoraproject.org/rpms/unzip/raw/rawhide/f/unzip-6.0-valgrind.patch
  https://src.fedoraproject.org/rpms/unzip/raw/rawhide/f/unzip-6.0-x-option.patch
  https://src.fedoraproject.org/rpms/unzip/raw/rawhide/f/unzip-6.0-overflow.patch
  https://src.fedoraproject.org/rpms/unzip/raw/rawhide/f/unzip-6.0-cve-2014-8139.patch
  https://src.fedoraproject.org/rpms/unzip/raw/rawhide/f/unzip-6.0-cve-2014-8140.patch
  https://src.fedoraproject.org/rpms/unzip/raw/rawhide/f/unzip-6.0-cve-2014-8141.patch
  https://src.fedoraproject.org/rpms/unzip/raw/rawhide/f/unzip-6.0-overflow-long-fsize.patch
  https://src.fedoraproject.org/rpms/unzip/raw/rawhide/f/unzip-6.0-heap-overflow-infloop.patch
  https://src.fedoraproject.org/rpms/unzip/raw/rawhide/f/unzip-6.0-alt-iconv-utf8.patch
  https://src.fedoraproject.org/rpms/unzip/raw/rawhide/f/unzip-6.0-alt-iconv-utf8-print.patch
  https://src.fedoraproject.org/rpms/unzip/raw/rawhide/f/0001-Fix-CVE-2016-9844-rhbz-1404283.patch
  https://src.fedoraproject.org/rpms/unzip/raw/rawhide/f/unzip-6.0-timestamp.patch
  https://src.fedoraproject.org/rpms/unzip/raw/rawhide/f/unzip-6.0-cve-2018-1000035-heap-based-overflow.patch
  https://src.fedoraproject.org/rpms/unzip/raw/rawhide/f/unzip-6.0-cve-2018-18384.patch
  https://src.fedoraproject.org/rpms/unzip/raw/rawhide/f/unzip-6.0-COVSCAN-fix-unterminated-string.patch
  https://src.fedoraproject.org/rpms/unzip/raw/rawhide/f/unzip-zipbomb-part1.patch
  https://src.fedoraproject.org/rpms/unzip/raw/rawhide/f/unzip-zipbomb-part2.patch
  https://src.fedoraproject.org/rpms/unzip/raw/rawhide/f/unzip-zipbomb-part3.patch
  https://src.fedoraproject.org/rpms/unzip/raw/rawhide/f/unzip-zipbomb-manpage.patch
  https://src.fedoraproject.org/rpms/unzip/raw/rawhide/f/unzip-zipbomb-part4.patch
  https://src.fedoraproject.org/rpms/unzip/raw/rawhide/f/unzip-zipbomb-part5.patch
  https://src.fedoraproject.org/rpms/unzip/raw/rawhide/f/unzip-zipbomb-part6.patch
)
cksums=('2837412136'
        '2363500664'
        '2655474932'
        '2129701736'
        '2949763206'
        '3334678305'
        '1855505314'
        '470779507'
        '1032422583'
        '3861582406'
        '64202688'
        '3141369720'
        '782710342'
        '1165565842'
        '4115987694'
        '3743903739'
        '518648444'
        '507117617'
        '167103177'
        '708922434'
        '1501392749'
        '2010412416'
        '337180857'
        '3325345526'
        '1531697882'
        '1432388777'
        '2012167156'
        '2213001841')

prepare() {
  cd ${pkgname}${pkgver}

	sed -e "/MANDIR =/s#)/#)/share/#" -i unix/Makefile

	patch -p1 -i $srcdir/unzip-6.0-exec-shield.patch
	patch -p1 -i $srcdir/unzip-6.0-close.patch
	patch -p1 -i $srcdir/unzip-6.0-attribs-overflow.patch
	patch -p1 -i $srcdir/unzip-6.0-symlink.patch # FS#60433
	patch -p1 -i $srcdir/unzip-6.0-format-secure.patch
	patch -p1 -i $srcdir/unzip-6.0-valgrind.patch
	patch -p1 -i $srcdir/unzip-6.0-x-option.patch
	patch -p1 -i $srcdir/unzip-6.0-overflow.patch # FS#44171
	patch -p1 -i $srcdir/unzip-6.0-cve-2014-8139.patch # FS#43300
	patch -p1 -i $srcdir/unzip-6.0-cve-2014-8140.patch # FS#43391
	patch -p1 -i $srcdir/unzip-6.0-cve-2014-8141.patch # FS#43300
	patch -p1 -i $srcdir/unzip-6.0-overflow-long-fsize.patch # FS#44171
	patch -p1 -i $srcdir/unzip-6.0-heap-overflow-infloop.patch # FS#46955
	patch -p1 -i $srcdir/unzip-6.0-alt-iconv-utf8.patch
	patch -p1 -i $srcdir/unzip-6.0-alt-iconv-utf8-print.patch
	patch -p1 -i $srcdir/0001-Fix-CVE-2016-9844-rhbz-1404283.patch
	patch -p1 -i $srcdir/unzip-6.0-timestamp.patch
	patch -p1 -i $srcdir/unzip-6.0-cve-2018-1000035-heap-based-overflow.patch # FS#69739
	patch -p1 -i $srcdir/unzip-6.0-cve-2018-18384.patch
	patch -p1 -i $srcdir/unzip-6.0-COVSCAN-fix-unterminated-string.patch
	patch -p1 -i $srcdir/unzip-zipbomb-part1.patch
	patch -p1 -i $srcdir/unzip-zipbomb-part2.patch
	patch -p1 -i $srcdir/unzip-zipbomb-part3.patch
	patch -p1 -i $srcdir/unzip-zipbomb-manpage.patch
	patch -p1 -i $srcdir/unzip-zipbomb-part4.patch
	patch -p1 -i $srcdir/unzip-zipbomb-part5.patch
	patch -p1 -i $srcdir/unzip-zipbomb-part6.patch
}

build() {
  cd ${pkgname}${pkgver}

	DEFINES='-DACORN_FTYPE_NFS -DWILD_STOP_AT_DIR -DLARGE_FILE_SUPPORT -DUNICODE_SUPPORT -DUNICODE_WCHAR -DUTF8_MAYBE_NATIVE -DNO_LCHMOD -DDATE_FORMAT=DF_YMD -DUSE_BZIP2 -DNOMEMCPY -DNO_WORKING_ISPRINT'

	make -f unix/Makefile \
    prefix=/usr \
		D_USE_BZ2=-DUSE_BZIP2 L_BZ2=-lbz2 \
		LF2="$LDFLAGS" CF="$CFLAGS $CPPFLAGS -I. $DEFINES" \
		unzips
}

package() {
  cd ${pkgname}${pkgver}

	make -f unix/Makefile prefix="${pkgdir}"/usr install
}
